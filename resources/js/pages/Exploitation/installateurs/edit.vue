<script setup lang="ts">
import BtnAjouter from '@/components/buttons/BtnAjouter.vue';
import BtnConfirmSupprimer from '@/components/buttons/BtnConfirmSupprimer.vue';
import BtnModifier from '@/components/buttons/BtnModifier.vue';
import FlashMessage from '@/components/FlashMessage.vue';
import InputError from '@/components/InputError.vue';
import LinkBtnAnnuler from '@/components/links/LinkBtnAnnuler.vue';
import LinkBtnRetour from '@/components/links/LinkBtnRetour.vue';
import LinkBtnSupprimer from '@/components/links/LinkBtnSupprimer.vue';
import Modal from '@/components/Modal.vue';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import AppLayout from '@/layouts/AppLayout.vue';
import { can } from '@/lib/can';
import AddInstallateurAdresse from '@/pages/exploitation/installateurs/AddInstallateurAdresse.vue';
import UpdateInstallateurAdresse from '@/pages/exploitation/installateurs/UpdateInstallateurAdresse.vue';
import { type BreadcrumbItem } from '@/types';
import { Head, useForm } from '@inertiajs/vue3';
import { ref } from 'vue';

const breadcrumbs: BreadcrumbItem[] = [
    {
        title: 'Exploitation',
        href: '#',
    },
    {
        title: 'Installateurs',
        href: route('exploitation.installateurs.index'),
    },
    {
        title: 'Modifier un Installateur',
        href: route('exploitation.installateurs.index'),
    },
];

const props = defineProps<{ installateur: any }>();
const installateur = props.installateur;

const form = useForm({
    designation_juridique: installateur.designation_juridique || '',
    nom_commercial: installateur.nom_commercial || '',
    siren: installateur.siren || '',
    num_etablissement: installateur.num_etablissement || '',
    numero_tva: installateur.numero_tva || '',
    telephone: installateur.telephone || '',
    email: installateur.email || '',
    site_web: installateur.site_web || '',
    actif: installateur.actif || false,
});

//Installateur Adresse update modal
const showModal = ref(false);
const addModal = ref(false);
const updating = ref<Record<string, any> | undefined>(undefined);
const infovalue = ref<Record<string, any> | undefined>(undefined);

const Show = (adresse: Record<string, any>, installateur: Record<string, any>) => {
    infovalue.value = installateur;
    updating.value = adresse;
    showModal.value = true;
};

const closeModal = () => {
    showModal.value = false;
    addModal.value = false;
    updating.value = undefined;
    infovalue.value = undefined;
};

const Add = (installateur: Record<string, any>) => {
    infovalue.value = installateur;
    addModal.value = true;
};

function closeAddModalCallback() {
    addModal.value = false;
}
function closeShowModalCallback() {
    showModal.value = false;
}

//Installateur adresse delete confirmation
const showDeleteModal = ref(false);
const deletingAdresse = ref<Record<string, any> | undefined>(undefined);
const confirmAdresseDelete = (installateur: Record<string, any>, adresse: Record<string, any>) => {
    deletingAdresse.value = adresse;
    showDeleteModal.value = true;
};

const formDelete = useForm({});

const deleteAdresse = () => {
    if (!deletingAdresse.value) return;
    //route('exploitation.installateurs.adresses.update', [props.installateur.id, props.adresse.id])
    formDelete.delete(route('exploitation.installateurs.adresses.destroy', [installateur, deletingAdresse.value]), {
        onSuccess: () => {
            showDeleteModal.value = false;
            deletingAdresse.value = undefined;
        },
    });
};
const CancelDeleteAdresse = () => {
    showDeleteModal.value = false;
    deletingAdresse.value = undefined;
};
</script>

<template>
    <Head title="Modification Installateur" />

    <AppLayout :breadcrumbs="breadcrumbs">
        <FlashMessage />
        <div class="flex h-full flex-1 flex-col gap-4 rounded-xl p-4">
            <div>
                <LinkBtnRetour :href="route('exploitation.installateurs.index')" />
            </div>
            <Tabs default-value="general" class="w-full">
                <TabsList>
                    <TabsTrigger value="general"> Général </TabsTrigger>
                    <TabsTrigger value="adresse0" v-if="props.installateur.adresses_count > 0">
                        Adresse {{ props.installateur.adresses[0].type }}</TabsTrigger
                    >
                    <TabsTrigger value="adresse1" v-if="props.installateur.adresses_count > 1">
                        Adresse {{ props.installateur.adresses[1].type }}
                    </TabsTrigger>
                    <TabsTrigger value="general" v-if="props.installateur.adresses_count < 2">
                        <BtnAjouter type="submit" text="une adresse" @click="Add(props.installateur)" />
                    </TabsTrigger>
                </TabsList>
                <TabsContent value="general">
                    <form class="flex flex-col gap-6" @submit.prevent="form.put(route('exploitation.installateurs.update', { id: installateur.id }))">
                        <div class="grid gap-2">
                            <Label for="designation_juridique">Libelle :</Label>
                            <Input
                                id="designation_juridique"
                                name="designation_juridique"
                                type="text"
                                :tabindex="1"
                                autocomplete="none"
                                v-model="form.designation_juridique"
                                class="w-1/2 border-gray-300"
                            />
                            <InputError class="mt-2" :message="form.errors.designation_juridique" />
                        </div>
                        <div class="grid gap-2">
                            <Label for="nom_commercial">Nom Commercial :</Label>
                            <Input
                                id="nom_commercial"
                                name="nom_commercial"
                                type="text"
                                :tabindex="2"
                                autocomplete="none"
                                v-model="form.nom_commercial"
                                class="w-1/2 border-gray-300"
                            />
                            <InputError class="mt-2" :message="form.errors.nom_commercial" />
                        </div>
                        <div class="flex gap-2">
                            <div class="flex w-1/4 flex-col">
                                <Label for="siren" class="mb-2 ml-1">SIREN:</Label>
                                <Input
                                    id="siren"
                                    name="siren"
                                    type="text"
                                    :tabindex="3"
                                    autocomplete="none"
                                    v-model="form.siren"
                                    class="w-3/4 border-gray-300"
                                />
                                <span class="ml-2 text-xs">9 chiffres</span>
                                <InputError class="mt-2" :message="form.errors.siren" />
                            </div>
                            <div class="flex w-1/4 flex-col">
                                <Label for="num_etablissement" class="mb-2 ml-1">Numéro d'Etablissement :</Label>
                                <Input
                                    id="num_etablissement"
                                    name="num_etablissement"
                                    type="text"
                                    :tabindex="4"
                                    autocomplete="none"
                                    v-model="form.num_etablissement"
                                    class="w-3/4 border-gray-300"
                                />
                                <InputError class="mt-2" :message="form.errors.num_etablissement" />
                                <span class="ml-2 text-xs">5 chiffres</span>
                            </div>
                        </div>
                        <div class="grid gap-2">
                            <Label for="numero_tva">TVA Intracommunautaire :</Label>
                            <Input
                                id="numero_tva"
                                name="numero_tva"
                                type="text"
                                :tabindex="5"
                                autocomplete="none"
                                v-model="form.numero_tva"
                                class="w-1/4 border-gray-300"
                            />
                            <InputError class="mt-2" :message="form.errors.numero_tva" />
                        </div>
                        <div class="flex gap-2">
                            <div class="flex w-1/4 flex-col gap-2">
                                <Label for="telephone">Téléphone :</Label>
                                <Input
                                    id="telephone"
                                    name="telephone"
                                    type="text"
                                    :tabindex="6"
                                    autocomplete="none"
                                    v-model="form.telephone"
                                    class="w-3/4 border-gray-300"
                                />
                                <InputError class="mt-2" :message="form.errors.telephone" />
                            </div>
                            <div class="flex w-1/4 flex-col gap-2">
                                <Label for="email">Email :</Label>
                                <Input
                                    id="email"
                                    name="email"
                                    type="text"
                                    :tabindex="7"
                                    autocomplete="none"
                                    v-model="form.email"
                                    class="w-3/4 border-gray-300"
                                />
                                <InputError class="mt-2" :message="form.errors.email" />
                            </div>
                        </div>
                        <div class="grid gap-2">
                            <Label for="site_web">Site web :</Label>
                            <Input
                                id="site_web"
                                name="site_web"
                                type="text"
                                :tabindex="8"
                                autocomplete="none"
                                v-model="form.site_web"
                                class="w-1/4 border-gray-300"
                            />
                            <InputError class="mt-2" :message="form.errors.site_web" />
                        </div>
                        <div class="flex gap-2">
                            <Label for="actif">Installateur Actif :</Label>
                            <Switch v-model="form.actif" id="actif" />
                            <InputError class="mt-2" :message="form.errors.actif" />
                        </div>

                        <div class="flex items-center gap-4">
                            <BtnModifier type="submit" />
                        </div>
                    </form>
                </TabsContent>
                <TabsContent value="adresse0" v-if="props.installateur.adresses_count > 0">
                    <div class="mt-4">
                        <div class="mb-2 flex flex-row items-center">
                            <Label class="min-w-28">Adresse</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].adresse }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].adresse_complement">
                            <Label class="min-w-28">Complément :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].adresse_complement }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].lieu_dit">
                            <Label class="min-w-28">Lieu-dit :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].lieu_dit }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].code_postal">
                            <Label class="min-w-28">Code Postal :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].code_postal }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].ville">
                            <Label class="min-w-28">Ville :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].ville }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center">
                            <Label class="min-w-28">Pays</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[0].pays }}</p>
                        </div>
                        <BtnModifier type="submit" @click="Show(props.installateur.adresses[0], props.installateur)" />
                        <LinkBtnSupprimer
                            v-if="can('exploit.installateur.modifier')"
                            @click="confirmAdresseDelete(props.installateur.id, props.installateur.adresses[0])"
                            class="ml-4 text-red-600 hover:text-red-900"
                        />
                    </div>
                </TabsContent>
                <TabsContent value="adresse1" v-if="props.installateur.adresses_count > 1">
                    <div class="mt-4">
                        <div class="mb-2 flex flex-row items-center">
                            <Label class="min-w-28">Adresse</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].adresse }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].adresse_complement">
                            <Label class="min-w-28">Complément :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].adresse_complement }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].lieu_dit">
                            <Label class="min-w-28">Lieu-dit :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].lieu_dit }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].code_postal">
                            <Label class="min-w-28">Code Postal :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].code_postal }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center" v-if="props.installateur.adresses[0].ville">
                            <Label class="min-w-28">Ville :</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].ville }}</p>
                        </div>
                        <div class="mb-2 flex flex-row items-center">
                            <Label class="min-w-28">Pays</Label>
                            <p class="px-2.5">{{ props.installateur.adresses[1].pays }}</p>
                        </div>
                        <BtnModifier type="submit" @click="Show(props.installateur.adresses[1], props.installateur)" />
                        <LinkBtnSupprimer
                            v-if="can('exploit.installateur.modifier')"
                            @click="confirmAdresseDelete(props.installateur.id, props.installateur.adresses[1])"
                            class="ml-4 text-red-600 hover:text-red-900"
                        />
                    </div>
                </TabsContent>
            </Tabs>
        </div>

        <!-- Show Installateur Adresse Update Modal -->
        <Modal :show="showModal" @close="closeModal">
            <UpdateInstallateurAdresse :adresse="updating" :installateur="infovalue" @closeShowModal="closeShowModalCallback" />
        </Modal>
        <!-- Add Installateur Adresse Update Modal -->
        <Modal :show="addModal" @close="closeModal">
            <AddInstallateurAdresse :installateur="infovalue" @closeAddModal="closeAddModalCallback" />
        </Modal>
        <!-- Installateur Adresse Delete Confirmation Modal -->
        <Modal :show="showDeleteModal" @close="CancelDeleteAdresse">
            <div class="p-6">
                <h2 class="text-center text-lg font-medium text-gray-900">Supprimer une adresse</h2>
                <p class="mt-8 text-gray-600">Etes-vous sur de vouloir supprimer l'adresse suivante ?</p>
                <p class="mt-2 w-full text-xl">
                    {{ deletingAdresse && deletingAdresse.adresse ? deletingAdresse.adresse : '' }}
                </p>
                <p class="mt-2 w-full text-xl">
                    {{ deletingAdresse && deletingAdresse.code_postal ? deletingAdresse.code_postal : '' }}
                    {{ deletingAdresse && deletingAdresse.ville ? deletingAdresse.ville : '' }}
                </p>
                <div class="mt-6 flex justify-center space-x-4">
                    <LinkBtnAnnuler @click="CancelDeleteAdresse" />
                    <BtnConfirmSupprimer @click="deleteAdresse" :disabled="formDelete.processing">Supprimer</BtnConfirmSupprimer>
                </div>
            </div>
        </Modal>
    </AppLayout>
</template>
